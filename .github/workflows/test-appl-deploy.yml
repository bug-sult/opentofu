name: TEST-APPL Deployment

on:
  push:
    branches: [ main, master ]
    paths:
      - 'kubernetes/test-appl/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'kubernetes/test-appl/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: Configure kubectl
      run: |
        mkdir -p $HOME/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
        
    - name: Validate Kubernetes manifests
      run: |
        kubectl --dry-run=client apply -f kubernetes/test-appl/namespace.yaml
        kubectl --dry-run=client apply -f kubernetes/test-appl/deployment.yaml
        kubectl --dry-run=client apply -f kubernetes/test-appl/service.yaml
        
    - name: Deploy to Kubernetes
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        kubectl apply -f kubernetes/test-appl/namespace.yaml
        kubectl apply -f kubernetes/test-appl/deployment.yaml
        kubectl apply -f kubernetes/test-appl/service.yaml
        
    - name: Wait for deployment
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        kubectl rollout status deployment/test-appl-frontend -n test-appl --timeout=300s
        
    - name: Verify deployment
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        kubectl get pods -n test-appl
        kubectl get svc -n test-appl
        echo "TEST-APPL deployed successfully!"
        
    - name: Create/Update ArgoCD Application
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        kubectl apply -f kubernetes/test-appl/argocd-application.yaml
        echo "ArgoCD Application created/updated for TEST-APPL"
        
    - name: Display access information
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "ğŸš€ TEST-APPL Deployment Complete!"
        echo "ğŸ“ Access URL: http://[NODE-IP]:30088"
        echo "ğŸ”„ ArgoCD will automatically sync future changes"
        kubectl get svc test-appl-service -n test-appl
